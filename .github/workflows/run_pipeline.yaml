name: run_pipeline
on: [push]
jobs:
  run:
    runs-on: [self-hosted,cml,gpu]
    steps:
      - uses: actions/checkout@v2
      - name: cml_run
        run: |
          echo "--- RUN ---" > report.md
          
          # Setup project
          pip install -r requirements.txt

          # Get data and artifacsts from DVC remote
          dvc pull

          # Run pipeline
          dvc repro

          # Compare metrics to main
          git fetch --prune

          echo "# Metrics" >> report.md
          dvc metrics diff --show-md main >> report.md

          cat dvclive/metrics.json >> report.md

          # Create report
          cml comment create report.md

          # Push new data and artifacts to DVC remote
          dvc push
